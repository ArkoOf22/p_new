{% extends 'app1/base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <section class="header-area">
    <h1>Welcome to the Kannada Audio To Sign Language Converter</h1>
  </section>

  <section class="interaction-area">
    <form action="" method="post" class="speech-form">
      {% csrf_token %}
      <div class="form-group">
        <label for="speechToText">Speak Now:</label>
        <div class="input-group">
          <button type="button" class="mic-button" id="start-recording">
            <img src="{% static 'mic.jpg' %}" alt="Microphone" class="mic-icon">
          </button>
          <input type="text" name="sen" class="text-input" id="speechToText" placeholder="Speak here">
        </div>
      </div>
      <button type="submit" class="submit-button">Submit</button>
    </form>
  </section>

  <section class="keywords-display">
    <h2>Key Words:</h2>
    <ul id="list">
      {% for word in words %}
        <li class="keyword">{{ word }}</li>
      {% endfor %}
    </ul>
  </section>

  <section class="video-area">
    <button class="play-pause-button" data-state="play">Play/Pause</button>
    <div class="video-wrapper">
      <video id="videoPlayer" preload="auto">
        <source src="" type="video/mp4">
        Your browser does not support HTML5 video.
      </video>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'kn-IN';

  document.querySelector('.mic-button').addEventListener('click', () => {
    console.log("Starting speech recognition...");
    recognition.start();
  });

  recognition.onresult = function(event) {
    document.getElementById('speechToText').value = event.results[0][0].transcript;
    console.log("Speech recognized: ", event.results[0][0].transcript);
  };

  const videoPlayer = document.getElementById('videoPlayer');
  const videos = document.querySelectorAll('#list li');
  const videoSource = Array.from(videos).map(video => `/assets/${video.innerText.trim()}.mp4`);
  let currentVideoIndex = 0;
  let delayBetweenVideos = 500; // 500 milliseconds delay

  function loadVideo(index) {
    if (videoSource[index]) {
      videoPlayer.src = videoSource[index];
      videoPlayer.load(); 
      videoPlayer.addEventListener('loadedmetadata', () => {
        playVideo(index);
      }, { once: true }); 
    } else {
      console.error("Video source not found for index: ", index);
    }
  }

  function playVideo(index) {
    if (videoSource[index]) {
      videoPlayer.play();
      highlightCurrentVideo(index);
    } else {
      console.error("Attempted to play an undefined video source at index: ", index);
    }
  }

  function highlightCurrentVideo(index) {
    videos.forEach((v, i) => {
      v.style.color = i === index ? '#D0B59A' : 'normal';
      v.style.fontSize = i === index ? 'xx-large' : 'normal';
    });
  }

  const playPauseButton = document.querySelector('.play-pause-button');
  playPauseButton.addEventListener('click', () => {
      if (videoPlayer.paused) {
          videoPlayer.play();
          playPauseButton.textContent = 'Pause';
          playPauseButton.dataset.state = 'pause';
      } else {
          videoPlayer.pause();
          playPauseButton.textContent = 'Play';
          playPauseButton.dataset.state = 'play';
      }
  });

  videoPlayer.addEventListener('ended', () => {
    if (currentVideoIndex + 1 < videoSource.length) {
      setTimeout(() => {
        currentVideoIndex++;
        loadVideo(currentVideoIndex);
      }, delayBetweenVideos);
    } else {
      console.log("All videos have been played. Playback stopped.");
    }
  });

  loadVideo(0); 
});
</script>

{% endblock %}
